{% assign piece = piece-library[key] | hydratePiece %} 
{% assign caption = caption | default:key %} 

{% if rotate %}
  {% assign piece2 = piece | rotatePiece | hydratePiece %} 
{% else %}
  {% assign piece2 = piece %} 
{% endif %}

<div class="map {{size}}">
<div class="actualMap">
{% for pos in piece2.elevationMap %}
  {% assign label = pos.z | hideOneLabels %} 
  {% assign adjustedColor = color | plus: pos.z | plus: -1 %}
  {% include square, x: pos.x, y: pos.y, color:adjustedColor, text:label %}
  {% else %}empty!
{% endfor %}
</div>
{% if caption %}
  <div class="caption" align="center">{{caption}}</div>
{% endif %}
</div>
